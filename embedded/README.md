

# Retro Duck Hunt: 임베디드 시스템(STM32) 개발 명세서

## 1\. 시스템 개요

본 문서는 **Retro Duck Hunt** 프로젝트의 임베디드 시스템(STM32F103RB) 펌웨어에 대한 하드웨어 연결 및 소프트웨어 동작 원리를 설명합니다.

이 시스템은 ADC(DMA)와 TIM2(타이머)를 활용하여 조도 데이터를 정밀하게 수집하며, **상태 머신(State Machine)** 구조를 통해 PC 및 블루투스 앱과 안정적으로 통신합니다.

-----

## 2\.  하드웨어 연결 가이드 (Pin Map)

회로 구성 시 아래 표를 반드시 준수하여 연결해야 합니다.

| 부품 (Component) | STM32 핀 | 설정 (Mode) | 연결 설명 & 주의사항 |
| :--- | :--- | :--- | :--- |
| **조도 센서** | **PA0** | Analog Input | 센서의 출력(Signal) 핀을 연결  |
| **진동 모터** | **PA1** | Output (PP) | 모터(+) 연결 (전류 부족 시 트랜지스터 사용 권장)  |
| **트리거 버튼** | **PC4** | Input (Pull-up) | **버튼 한 쪽: PC4, 다른 쪽: GND** (내부 풀업 사용) |
| **PC 통신** (USB-TTL) | **PA9** (TX)<br>**PA10** (RX) | USART1 |STM32 TX ↔ USB RX<br>STM32 RX ↔ USB TX **(교차 연결)**  |
| **블루투스** (FB755AC) | **PD5** (TX)<br>**PD6** (RX) | USART2 (**Remap**) | **주의:** PA2/3 아님. PD5/6 사용.<br>STM32 TX ↔ BT RX **(교차 연결)**  |

> ** 전원 및 접지 주의사항**
> **GND 공통화:** 보드, 센서, 블루투스 모듈, USB-TTL의 GND(접지는 반드시 모두 서로 연결되어 있어야 통신이 가능합니다. 
>
>   * **Remap 설정:** 블루투스 통신을 위해 코드 상에서 `GPIO_PinRemapConfig`가 적용되어 있습니다. 하드웨어 연결 시 핀 번호를 다시 확인하세요.
-----

## 3\.  소프트웨어 핵심 동작 원리

### A. "블랙박스" 센서 기록 (ADC + DMA + Circular Buffer)

조도 센서 데이터는 CPU의 간섭 없이 하드웨어(DMA가 자동으로 수집합니다.

  * **작동 방식:** `TIM2` 타이머가 **2kHz (0.5ms)** 간격으로 ADC 변환을 트리거합니다.
  * **DMA (Direct Memory Access):** 변환된 조도 데이터는 `adc_buf` 배열에 **순환(Circular)** 방식으로 계속 덮어씌워집니다. 
  * **장점:** PC와 통신하거나 다른 작업을 하는 도중에도 센서 데이터가 누락되지 않고 120ms 분량의 데이터가 항상 유지됩니다. 

### B. 통신 브리지 (PC ↔ 앱 중계)

STM32는 PC 게임과 모바일 앱 사이의 중계기 역할을 수행합니다.

  * **PC → STM32 (USART1):** 인터럽트(`USART1_IRQHandler`)를 사용하여 **비차단(Non-blocking)** 방식으로 데이터를 수신합니다. 긴 문자열이 와도 시스템이 멈추지 않습니다. 
  * **STM32 → 앱 (USART2):** PC에서 수신된 `STATUS` 메시지(점수 등)는 별도의 파싱 없이 즉시 블루투스(USART2로 전달합니다 (Pass-through).

### C. 사격 프로세스 (State Machine)

시스템은 3가지 상태로 구분되어 동작합니다.

1.  **IDLE (대기 상태)**
      * 트리거 버튼(`PC4`) 입력을 대기합니다.
2.  **WAIT\_ACK (응답 대기)**
      * 트리거 발생 시 `TRIG` 메시지를 PC로 전송하고 진동 모터를 작동합니다.
      * PC로부터 `ACK` 메시지가 도착할 때까지 대기합니다.
3.  **SAMPLING (계측 상태)**
      * `ACK` 수신 시점부터 **120ms** 동안 대기합니다.
      * 120ms 후, DMA 버퍼에서 해당 구간의 데이터를 역추적하여 최대 밝기(최소 ADC 값를 검출합니다.)
